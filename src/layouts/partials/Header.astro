---
import Logo from "@/components/Logo.astro";
import menu from "@/config/menu.json";
import { IoSearch } from "react-icons/io5";
import { getSinglePage } from "@/lib/contentParser.astro";

export interface ChildNavigationLink {
  name: string;
  url: string;
}

export interface NavigationLink {
  name: string;
  url: string;
  hasChildren?: boolean;
  children?: ChildNavigationLink[];
}

const { main }: { main: NavigationLink[] } = menu;

// ê²€ìƒ‰ì„ ìœ„í•œ í¬ìŠ¤íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
const posts = await getSinglePage("posts");
const searchList = posts.map((item) => ({
  slug: item.id,
  data: item.data,
  content: item.body,
}));
---

<header class="header pt-6 relative">
  <nav class="navbar container">
    <!-- logo -->
    <div class="order-0">
      <Logo />
    </div>

    <!-- navbar toggler -->
    <input id="nav-toggle" type="checkbox" class="hidden" />
    <label
      id="show-button"
      for="nav-toggle"
      class="order-2 flex cursor-pointer items-center text-black md:order-1 md:hidden"
    >
      <svg class="h-6 fill-current" viewBox="0 0 20 20">
        <title>Menu Open</title>
        <path d="M0 3h20v2H0V3z m0 6h20v2H0V9z m0 6h20v2H0V0z"></path>
      </svg>
    </label>
    <label
      id="hide-button"
      for="nav-toggle"
      class="order-2 hidden cursor-pointer items-center text-black md:order-1"
    >
      <svg class="h-6 fill-current" viewBox="0 0 20 20">
        <title>Menu Close</title>
        <polygon
          points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2"
          transform="rotate(45 10 10)"></polygon>
      </svg>
    </label>
    <!-- /navbar toggler -->

    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ -->
    <ul
      id="nav-menu"
      class="navbar-nav order-3 hidden w-full md:order-1 md:flex md:w-auto"
    >
      {
        main.map((menu) => (
          <>
            {menu.hasChildren ? (
              <li class="nav-item nav-dropdown group relative cursor-pointer">
                <span class="nav-link inline-flex items-center">
                  {menu.name}
                  <svg class="h-5 w-5 fill-current" viewBox="0 0 20 20">
                    <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                  </svg>
                </span>
                <ul class="nav-dropdown-list hidden group-hover:block md:invisible md:absolute md:block md:opacity-0 md:group-hover:visible md:group-hover:opacity-100">
                  {menu.children?.map((child) => (
                    <li class="nav-dropdown-item">
                      <a href={child.url} class="nav-dropdown-link">
                        {child.name}
                      </a>
                    </li>
                  ))}
                </ul>
              </li>
            ) : (
              <li class="nav-item">
                <a href={menu.url} class="nav-link block">
                  {menu.name}
                </a>
              </li>
            )}
          </>
        ))
      }
    </ul>

    <!-- ê²€ìƒ‰ì°½ -->
    <div class="order-1 ml-auto flex items-center md:order-2 md:ml-4 relative">
      <!-- ëª¨ë°”ì¼ ì „ìš© ê²€ìƒ‰ ì•„ì´ì½˜ -->
      <button
        id="search-toggle"
        class="block lg:hidden p-2 text-gray-600 hover:text-primary"
        aria-label="ê²€ìƒ‰ ì—´ê¸°"
      >
        <IoSearch className="w-5 h-5" />
      </button>

      <!-- ê²€ìƒ‰ ì…ë ¥ì°½ (ë°˜ì‘í˜•) -->
      <input
        id="search-input"
        class="transition-all duration-300 ease-in-out bg-light border border-border rounded-lg px-4 py-2 pr-10 text-sm placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary focus:shadow-md
        w-0 opacity-0 absolute right-0 top-full mt-1 z-[60] lg:static lg:mt-0 lg:relative lg:opacity-100
        lg:w-48 xl:w-64"
        placeholder="ê²€ìƒ‰..."
        type="text"
        autocomplete="off"
      />

      <!-- ë°ìŠ¤í¬íƒ‘ ì „ìš© ê²€ìƒ‰ ë²„íŠ¼ -->
      <button
        id="search-button"
        class="hidden lg:block absolute lg:static right-2 p-1 text-gray-500 hover:text-primary hover:scale-110 transition-all duration-200"
        title="ê²€ìƒ‰"
        aria-label="ê²€ìƒ‰"
      >
        <IoSearch className="w-4 h-4" />
      </button>
    </div>
  </nav>

  <!-- ê²€ìƒ‰ê²°ê³¼ ë“œë¡­ë‹¤ìš´ -->
  <div id="search-results" class="absolute top-full left-0 right-0 z-40 hidden">
    <div class="container">
      <div class="relative">
        <div
          id="search-results-content"
          class="absolute right-0 bg-white rounded-lg shadow-xl border border-gray-200 mt-2 w-80 md:w-96 max-h-96 overflow-y-auto z-50"
        >
          <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>
  </div>
</header>

<!-- ê²€ìƒ‰ ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸ -->
<script is:inline define:vars={{ searchList }}>
  let fuse;
  let isInitialized = false; // ì´ˆê¸°í™” ìƒíƒœ ì¶”ì 

  // DOM ìš”ì†Œë“¤
  let searchInput,
    searchButton,
    searchToggle,
    searchResults,
    searchResultsContent;

  // DOM ìš”ì†Œ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
  function getElements() {
    searchInput = document.getElementById("search-input");
    searchButton = document.getElementById("search-button");
    searchToggle = document.getElementById("search-toggle");
    searchResults = document.getElementById("search-results");
    searchResultsContent = document.getElementById("search-results-content");

    console.log("DOM elements:", {
      searchInput: !!searchInput,
      searchButton: !!searchButton,
      searchToggle: !!searchToggle,
      searchResults: !!searchResults,
      searchResultsContent: !!searchResultsContent,
      searchListLength: searchList?.length,
    });
  }

  // Fuse.js ë™ì  ë¡œë“œ ë° ì´ˆê¸°í™”
  async function initializeSearch() {
    if (isInitialized) return;

    try {
      console.log("Initializing search...");
      const module = await import("https://cdn.skypack.dev/fuse.js@6.6.2");
      const Fuse = module.default;

      fuse = new Fuse(searchList, {
        keys: ["data.title", "data.categories", "data.tags", "content"],
        includeMatches: true,
        minMatchCharLength: 2,
        threshold: 0.5,
      });

      isInitialized = true;
      console.log("Search initialized successfully");
    } catch (error) {
      console.error("Failed to load Fuse.js:", error);
    }
  }

  // ê²€ìƒ‰ ì‹¤í–‰
  function performSearch(query) {
    console.log("Performing search for:", query);

    if (!fuse || query.length < 2) {
      searchResults.classList.add("hidden");
      return;
    }

    const results = fuse.search(query);
    console.log("Search results:", results.length);
    displaySearchResults(results, query);
  }

  // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
  function displaySearchResults(results, query) {
    if (results.length === 0) {
      searchResultsContent.innerHTML = `
        <div class="p-4 text-center text-gray-500">
          <p>"${query}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      `;
    } else {
      searchResultsContent.innerHTML = `
        <div class="p-4">
          <div class="mb-3 text-sm text-gray-600 border-b pb-2">
            "${query}"ì— ëŒ€í•œ ${results.length}ê°œì˜ ê²°ê³¼
          </div>
          ${results
            .slice(0, 5)
            .map(
              ({ item }) => `
            <div class="group py-3 border-b border-gray-100 last:border-b-0 hover:bg-gray-50 -mx-4 px-4 transition-colors cursor-pointer search-result-item" data-href="/${item.slug}">
              <h3 class="mb-1">
                <span class="text-base font-semibold text-dark group-hover:text-primary transition-all duration-200">
                  ${item.data.title}
                </span>
              </h3>
              <div class="flex items-center text-xs text-gray-500 mb-2">
                <span class="mr-3">${new Date(item.data.date).toLocaleDateString("ko-KR")}</span>
                <span>${item.data.categories.join(", ")}</span>
              </div>
              <p class="text-gray-600 text-sm leading-relaxed">
                ${item.content ? item.content.slice(0, 100) + "..." : item.data.description || ""}
              </p>
            </div>
          `,
            )
            .join("")}
          ${
            results.length > 5
              ? `
            <div class="p-3 text-center border-t">
              <a href="/search?q=${encodeURIComponent(query)}" class="text-primary hover:underline text-sm font-medium">
                ëª¨ë“  ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸° (${results.length}ê°œ)
              </a>
            </div>
          `
              : ""
          }
        </div>
      `;
    }

    searchResults.classList.remove("hidden");
  }

  // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
  function hideSearchResults() {
    searchResults.classList.add("hidden");
  }

  // ëª¨ë°”ì¼ ê²€ìƒ‰ í† í´ í´ë¦­
  function handleToggleClick(e) {
    e.preventDefault();
    console.log("ğŸ“± ëª¨ë°”ì¼ ê²€ìƒ‰ í† ê¸€ í´ë¦­!");

    if (!searchInput) return;

    const isOpen = !searchInput.classList.contains("w-0");

    if (isOpen) {
      // ë‹«ê¸°
      searchInput.classList.remove("w-60", "opacity-100");
      searchInput.classList.add("w-0", "opacity-0");
      searchInput.blur();
      hideSearchResults();
    } else {
      // ì—´ê¸°
      searchInput.classList.remove("w-0", "opacity-0");
      searchInput.classList.add("w-60", "opacity-100");
      setTimeout(() => searchInput.focus(), 100);
    }
  }

  // ë“œë¡­ë‹¤ìš´ í† ê¸€ í•¨ìˆ˜
  function toggleDropdown(index) {
    const dropdown = document.getElementById(`dropdown-${index}`);
    const arrow = document.getElementById(`dropdown-arrow-${index}`);

    if (dropdown && arrow) {
      const isHidden = dropdown.classList.contains("hidden");

      // ëª¨ë“  ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
      document.querySelectorAll('[id^="dropdown-"]').forEach((el) => {
        if (el.id !== `dropdown-${index}`) {
          el.classList.add("hidden");
        }
      });

      // ëª¨ë“  í™”ì‚´í‘œ ì´ˆê¸°í™”
      document.querySelectorAll('[id^="dropdown-arrow-"]').forEach((el) => {
        if (el.id !== `dropdown-arrow-${index}`) {
          el.style.transform = "rotate(0deg)";
        }
      });

      // í˜„ì¬ ë“œë¡­ë‹¤ìš´ í† ê¸€
      if (isHidden) {
        dropdown.classList.remove("hidden");
        arrow.style.transform = "rotate(180deg)";
      } else {
        dropdown.classList.add("hidden");
        arrow.style.transform = "rotate(0deg)";
      }
    }
  }

  // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
  window.toggleDropdown = toggleDropdown;

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
  function removeEventListeners() {
    if (searchButton) {
      searchButton.removeEventListener("click", handleSearchClick);
    }
    if (searchInput) {
      searchInput.removeEventListener("keydown", handleSearchKeydown);
      searchInput.removeEventListener("input", handleSearchInput);
      searchInput.removeEventListener("focus", handleSearchFocus);
    }
    if (searchToggle) {
      searchToggle.removeEventListener("click", handleToggleClick);
    }
    if (searchResults) {
      searchResults.removeEventListener("click", handleResultsClick);
    }
    document.removeEventListener("click", handleDocumentClick);
    document.removeEventListener("keydown", handleDocumentKeydown);
  }

  // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
  // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
  function handleSearchClick(e) {
    e.preventDefault();
    const query = searchInput.value.trim();
    console.log("Search button clicked, query:", query);
    if (query) {
      performSearch(query);
    }
  }

  // enterë¡œ ê²€ìƒ‰
  function handleSearchKeydown(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      const query = searchInput.value.trim();
      console.log("Enter pressed, query:", query);
      if (query) {
        performSearch(query);
      }
    }
  }

  // íƒ€ì´í•‘ ì‹œ ê²€ìƒ‰ ì‹œí–‰
  let searchTimeout;
  function handleSearchInput(e) {
    clearTimeout(searchTimeout);
    const query = e.target.value.trim();

    if (query.length < 2) {
      hideSearchResults();
      return;
    }

    // 500ms ì§€ì—° í›„ ê²€ìƒ‰ (ë„ˆë¬´ ìì£¼ ê²€ìƒ‰ë˜ì§€ ì•Šë„ë¡)
    searchTimeout = setTimeout(() => {
      performSearch(query);
    }, 500);
  }

  // ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ : í˜ì´ì§€ ì´ë™
  function handleResultsClick(e) {
    // ê²€ìƒ‰ ê²°ê³¼ ì•„ì´í…œ í´ë¦­ ì‹œ í˜ì´ì§€ ì´ë™
    const resultItem = e.target.closest(".search-result-item");
    if (resultItem) {
      const href = resultItem.getAttribute("data-href");
      if (href) {
        hideSearchResults();
        window.location.href = href;
        return;
      }
    }

    // "ëª¨ë“  ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸°" ë§í¬ í´ë¦­ ì‹œ
    if (e.target.tagName === "A") {
      hideSearchResults();
    }
  }

  // ê²€ìƒ‰ ê²°ê³¼ ì¬í‘œì‹œ (ìˆë‹¤ë©´)
  function handleSearchFocus() {
    const query = searchInput.value.trim();
    if (query.length >= 2) {
      performSearch(query);
    }
  }

  // ì™¸ë¶€ í´ë¦­ : ê²€ìƒ‰ê²°ê³¼ ë‹«ê¸°
  function handleDocumentClick(e) {
    const isSearchArea =
      e.target.closest("#search-input") ||
      e.target.closest("#search-button") ||
      e.target.closest("#search-toggle") ||
      e.target.closest("#search-results");

    if (!isSearchArea) {
      hideSearchResults();
    }
  }

  // ESC : ê²€ìƒ‰ê²°ê³¼ ë‹«ê¸°
  function handleDocumentKeydown(e) {
    if (e.key === "Escape") {
      hideSearchResults();
    }
  }

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  function attachEventListeners() {
    console.log("Attaching event listeners...");

    // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
    removeEventListeners();

    // ìƒˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    if (searchButton) {
      searchButton.addEventListener("click", handleSearchClick);
    }

    if (searchInput) {
      searchInput.addEventListener("keydown", handleSearchKeydown);
      searchInput.addEventListener("input", handleSearchInput);
      searchInput.addEventListener("focus", handleSearchFocus);
    }

    if (searchToggle) {
      searchToggle.addEventListener("click", handleToggleClick);
      console.log("ëª¨ë°”ì¼ í† ê¸€ ì´ë²¤íŠ¸ ë“±ë¡ë¨");
    }

    if (searchResults) {
      searchResults.addEventListener("click", handleResultsClick);
    }

    document.addEventListener("click", handleDocumentClick);
    document.addEventListener("keydown", handleDocumentKeydown);

    console.log("Event listeners attached");
  }

  // ì´ˆê¸°í™” í•¨ìˆ˜
  async function init() {
    console.log("Initializing search functionality...");
    getElements();

    if (
      !searchInput ||
      !searchButton ||
      !searchResults ||
      !searchResultsContent
    ) {
      console.error("Required DOM elements not found");
      return;
    }

    await initializeSearch();
    attachEventListeners();

    console.log("Search functionality ready");
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    // DOMì´ ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì¦‰ì‹œ ì‹¤í–‰
    init();
  }

  // í˜ì´ì§€ ë³€ê²½ ì‹œ ì¬ì´ˆê¸°í™” (Astroì˜ view transitions ì§€ì›)
  document.addEventListener("astro:page-load", () => {
    console.log("í˜ì´ì§€ ì „í™˜ë¨, ê²€ìƒ‰ ê¸°ëŠ¥ ì¬ì´ˆê¸°í™”...");

    isInitialized = false;
    init();
  });

  // ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì‹œ ì¬ì´ˆê¸°í™”
  window.addEventListener("pageshow", (event) => {
    if (event.persisted) {
      console.log("ìºì‹œì—ì„œ í˜ì´ì§€ ë³µì›ë¨, ê²€ìƒ‰ ê¸°ëŠ¥ ì¬ì´ˆê¸°í™”...");

      isInitialized = false;
      init();
    }
  });
</script>
