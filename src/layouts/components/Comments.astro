---
export interface Props {
  theme?: "light" | "dark" | "preferred_color_scheme";
}

const { theme = "preferred_color_scheme" } = Astro.props;
---

<div id="comments" class="mt-12 pt-8 border-t border-border">
  <!-- <h3 class="text-xl font-bold mb-6 text-dark">ğŸ’¬ ëŒ“ê¸€</h3> -->

  <!-- ë¡œë”© í‘œì‹œ -->
  <div id="giscus-loading" class="text-center py-8 text-text">
    <div
      class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-primary"
    >
    </div>
    <p class="mt-2 text-sm">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
  </div>

  <!-- Giscus ì»¨í…Œì´ë„ˆ -->
  <div id="giscus-container"></div>
</div>

<script define:vars={{ theme }}>
  function loadGiscus() {
    // ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ì œê±° (í˜ì´ì§€ ì „í™˜ ëŒ€ì‘)
    const existingScript = document.getElementById("giscus-script");
    if (existingScript) {
      existingScript.remove();
    }

    // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
    const container = document.getElementById("giscus-container");
    if (!container) return;
    container.innerHTML = "";

    // Giscus ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
    const script = document.createElement("script");
    script.id = "giscus-script";
    script.src = "https://giscus.app/client.js";

    // ğŸ”§ giscus.appì—ì„œ ìƒì„±ëœ ì‹¤ì œ ì„¤ì •ê°’ ì ìš©!
    script.setAttribute("data-repo", "yujeong0411/yujeong0411.github.io");
    script.setAttribute("data-repo-id", "R_kgDOPEzrog");
    script.setAttribute("data-category", "General");
    script.setAttribute("data-category-id", "DIC_kwDOPEzros4CsgEi");
    script.setAttribute("data-mapping", "pathname");
    script.setAttribute("data-strict", "0");
    script.setAttribute("data-reactions-enabled", "1");
    script.setAttribute("data-emit-metadata", "1");
    script.setAttribute("data-input-position", "top");
    script.setAttribute("data-theme", theme);
    script.setAttribute("data-lang", "ko");
    script.setAttribute("data-loading", "lazy");
    script.crossOrigin = "anonymous";
    script.async = true;

    // ë¡œë”© ì™„ë£Œ ì²˜ë¦¬
    script.onload = function () {
      const loading = document.getElementById("giscus-loading");
      if (loading) {
        loading.style.display = "none";
      }
    };

    // ì—ëŸ¬ ì²˜ë¦¬
    script.onerror = function () {
      const loading = document.getElementById("giscus-loading");
      if (loading) {
        loading.innerHTML =
          '<p class="text-red-500">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    };

    container.appendChild(script);
  }

  // ì´ˆê¸° ë¡œë“œ
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", loadGiscus);
  } else {
    loadGiscus();
  }

  // Astro í˜ì´ì§€ ì „í™˜ ëŒ€ì‘
  document.addEventListener("astro:page-load", () => {
    const loading = document.getElementById("giscus-loading");
    if (loading) {
      loading.style.display = "block";
    }

    // ì•½ê°„ì˜ ì§€ì—° í›„ ë¡œë“œ (DOM ì•ˆì •í™”)
    setTimeout(loadGiscus, 100);
  });

  // í…Œë§ˆ ë³€ê²½ ëŒ€ì‘ (ì„ íƒì‚¬í•­)
  document.addEventListener("theme-change", (e) => {
    const iframe = document.querySelector('iframe[title="Comments"]');
    if (iframe) {
      iframe.contentWindow.postMessage(
        { giscus: { setConfig: { theme: e.detail.theme } } },
        "https://giscus.app",
      );
    }
  });
</script>

<style>
  #comments {
    max-width: 100%;
  }

  /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }

  /* Giscus iframe ìŠ¤íƒ€ì¼ë§ */
  :global(.giscus-frame) {
    width: 100% !important;
    border: none !important;
    color-scheme: auto;
  }

  /* ëŒ“ê¸€ ì„¹ì…˜ ì „ì²´ ìŠ¤íƒ€ì¼ */
  #giscus-container {
    min-height: 200px;
  }

  /* ë°˜ì‘í˜• ëŒ€ì‘ */
  @media (max-width: 768px) {
    #comments {
      margin-top: 2rem;
      padding-top: 2rem;
    }

    #comments h3 {
      font-size: 1.25rem;
    }
  }
</style>
