---
import { getSinglePage } from "@/lib/contentParser.astro";
import { slugify, humanize } from "@/lib/utils/textConverter";

// get taxonomy from frontmatter
export const getTaxonomy = async (collection: any, name: string) => {
  const singlePages = await getSinglePage(collection);
  const taxonomyPages = singlePages.map((page: any) => page.data[name]);
  let taxonomies: string[] = [];
  for (let i = 0; i < taxonomyPages.length; i++) {
    const categoryArray = taxonomyPages[i];
    for (let j = 0; j < categoryArray.length; j++) {
      taxonomies.push(slugify(categoryArray[j])!);
    }
  }
  const taxonomy = [...new Set(taxonomies)];
  return taxonomy;
};

// get all taxonomies from frontmatter
export const getAllTaxonomy = async (collection: any, name: string) => {
  const singlePages = await getSinglePage(collection);
  const taxonomyPages = singlePages.map((page: any) => page.data[name]);
  let taxonomies: string[] = [];
  for (let i = 0; i < taxonomyPages.length; i++) {
    const categoryArray = taxonomyPages[i];
    for (let j = 0; j < categoryArray.length; j++) {
      taxonomies.push(slugify(categoryArray[j])!);
    }
  }
  return taxonomies;
};

// ðŸ†• get taxonomy with post counts
export const getTaxonomyWithCounts = async (collection: any, name: string) => {
  const singlePages = await getSinglePage(collection);
  const taxonomyCount: {
    [key: string]: { name: string; slug: string; count: number };
  } = {};

  // ëª¨ë“  í¬ìŠ¤íŠ¸ë¥¼ ëŒë©´ì„œ ì¹´í…Œê³ ë¦¬ë³„ ê°œìˆ˜ ê³„ì‚°
  singlePages.forEach((page: any) => {
    const categories = page.data[name] || [];
    categories.forEach((category: string) => {
      const categorySlug = slugify(category)!;

      if (taxonomyCount[categorySlug]) {
        taxonomyCount[categorySlug].count += 1;
      } else {
        taxonomyCount[categorySlug] = {
          name: humanize(category),
          slug: categorySlug,
          count: 1,
        };
      }
    });
  });

  // ê°ì²´ë¥¼ ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ì´ë¦„ìˆœìœ¼ë¡œ ì •ë ¬
  return Object.values(taxonomyCount).sort((a, b) =>
    a.name.localeCompare(b.name),
  );
};

// ðŸ†• get specific taxonomy count
export const getTaxonomyCount = async (
  collection: any,
  name: string,
  taxonomySlug: string,
) => {
  const singlePages = await getSinglePage(collection);

  return singlePages.filter((page: any) => {
    const categories = page.data[name] || [];
    return categories.some(
      (category: string) => slugify(category) === taxonomySlug,
    );
  }).length;
};
---
